<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Porting Sparklines to App Engine</title>
  <meta name="description" content="The title of this article is actually misleading as the code isn&#39;t ported, but altered to run on both App Engine and under CGI. App Engine exposes a CGI envi...">
  <meta name="google-site-verification" content="vZSL2JjLp0S_VXH743XRWWgko2D6B124A8pUAqT4FFk" />

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://bitworking.org/news/2009/01/porting-sparklines-to-app-engine">
  <link rel="alternate" type="application/atom+xml" title="BitWorking" href="/news/feed/">
  <link rel="author" href="/about/">
  <link href="https://webmention.bitworking.org/IncomingWebMention" rel="webmention" />
  <script async defer src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML'></script>
  <meta name="twitter:site"    content="@bitworking">
  <meta name="twitter:creator" content="@bitworking">
  <meta name="twitter:title"   content="Porting Sparklines to App Engine">
  <meta name="twitter:description" content="  
        The title of this article is actually misleading
        as the code isn't ported, but altered to run on both
        App Engine and under CGI. App Engine exposes a CGI 
        environment that your requests run under, so the real
        challenge comes from the differences in the runtime
        environment.
        
Imaging

        The first big difference is that PIL (the Python Imaging
        Library) isn't available on App Engine, and it's not possible
        to add C extensions to your App Engine project, so we will have to find
        a pure Python substitute. Such a substitute exists in
        pngcanvas, a pure Python module for creating PNG images.
        

        My use of pngcanvas is actually the completion of a virtuous circle: 
        I originally created the Python sparklines service and
        why wanted to create one in Ruby 
        using pure Ruby and BMPs, then that was the jumping off point for some commenters to
        do the same for PNGs, which led 
        mir.aculo.us to create 
        a library for creating sparkline PNGs in pure Ruby, which 
        Rui Carmo then ported to Python, 
        which I will now use in porting the original sparklines code to App Engine.
        Small world.
        

        Now you probably won't want to use pngcanvas for 
        extensive graphics manipulation, but since sparklines
        are small it will be just fine.
        As a side note, I really like the simplicity of the
        pngcanvas interface, the port actually resulted in removing
        lines of code compared to PIL, which is always a good sign.
        

        The one problem that arises in moving from PIL to pngcanvas
        is the lack of color names. PIL allows you to specify
        colors by name, something pngcanvas doesn't support.
        Luckily X11 includes a convenient list of color names
        and their equivalent in RGB triples (/etc/X11/rgb.txt)
        which just needs to be converted into a form usable for
        Python. I could write code to import rgb.txt via Python, but
        since I have to upload the file to App Engine anyway, I'll 
        exercise the macro capabilities of my text editor and
        covert it into a Python file:
        
_colors = {
"snow": (255, 250, 250, 255),
"ghost white": (248, 248, 255, 255),
"ghostwhite": (248, 248, 255, 255),
# ...
"light green": (144, 238, 144, 255),
"lightgreen": (144, 238, 144, 255)
}
def colors(name):
    name = name.strip().lower()
    if name in _colors:
        return _colors[name]
    else:
        return (0, 0, 0, 255)

        Now I can use rgb.py to covert color names into RGB triples, 
        or in this case RGBA tuples like pngcanvas expects. 
        
App.yaml

        If we wanted to do the absolute minimum then
        that would be all the changes we would need to make.
        The only extra step needed for App Engine is to describe
        the files we are using and their location so it knows
        what to upload and how to direct requests, which is done
        through the app.yaml file.
        
application: sparklines-bitworking
version: 1
runtime: python
api_version: 1
handlers:
- url: /
  static_files: index.html
  upload: index.html
- url: /spark.js
  static_files: spark.js 
  upload: spark.js 
- url: /spark.cgi?.*
  script: spark.py


        And were done. But there are some other changes we can make
        to take full advantage of the App Engine platform.
        
The main() optimization

        If your handler script exports a main() function
        that takes no arguments then App Engine will keep the script
        cached and call main() for subsequent requests. 
        Skipping the evaluation of the script on each
        request improves performance, so we'll break out the code into two modules,
        main.py which will be our script handler
        and script.py which will contain
        all of the sparkline drawing logic.
        That change is now reflected in our app.yaml
        file:
        
application: sparklines-bitworking
version: 1
runtime: python
api_version: 1
handlers:
- url: /
  static_files: index.html
  upload: index.html
- url: /spark.js
  static_files: spark.js 
  upload: spark.js 
- url: /spark.cgi?.*
  script: main.py
        
And the main.py is very simple:
from spark import plot
def main():
    plot()
if __name__ == '__main__':
    main()  
Memcache

        Now the original sparklines code already made good use
        HTTP caching by setting ETag: and Cache-control: headers, but
        we can do more under App Engine by using the memcache service.
        After drawing each sparkline we can store the PNG in 
        memcache using a hash of the incoming request query 
        parameters and the application version as the key 
        and subsequently look for images in memcache when 
        requests come in using that same hash. If there is a hit we can avoid 
        doing any drawing at all.
        We still want to be able to use the code on a
        system that doesn't have memcache support so
        we will make its use conditional.
        
try:
    from google.appengine.api import memcache
except:
    memcache = None

Check for memcached images:
def plot():
    plot_types = {
        'discrete': plot_sparkline_discrete, 
        'impulse': lambda data, args: plot_sparkline_discrete(data, args, True), 
        'smooth': plot_sparkline_smooth,
        'error': plot_error
    }
    if not os.environ['REQUEST_METHOD'] in ['GET', 'HEAD']:
        error("Status: 405 Method Not Allowed")
    if_none_match = os.environ.get('HTTP_IF_NONE_MATCH', '')
    hashkey = entity_hash()
    if if_none_match and hashkey == if_none_match:
        not_modified()
    if memcache:
        image_data = memcache.get(hashkey)
        if image_data is not None:
            ok()
            sys.stdout.write(image_data)
            sys.exit()
    form = cgi.FieldStorage()
    # ...
    
Populate memcache with images after drawing them:

    # ...
    image_data = plot_types[type](data, args)
    if memcache:
        memcache.add(hashkey, image_data)
    # ... 
    

    By making the use of memcache conditional on its presence
    this code can now be used both on App Engine and also on my 
    server which doesn't have memcache. 
    

    This service can be found hosted at 
    both http://bitworking.org/projects/sparklines/ 
    and on Google App Engine at http://sparklines-bitworking.appspot.com/.
    Both are running the identical code, which can be found at  
    http://bitbucket.org/jcgregorio/sparklines/overview.
    
  
  
">
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content="https://bitworking.org/images/newlogo.png">
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">
      <img src="https://bitworking.org/images/newlogo.png" >
      BitWorking
    </a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Porting Sparklines to App Engine</h1>
    <p class="post-meta">
      <a class="u-url" href="/news/2009/01/porting-sparklines-to-app-engine">
        <time datetime="2009-01-20T00:00:00-05:00" itemprop="datePublished" class="dt-published">
          
          Jan 20, 2009
        </time>
      </a>
      â€¢ <a rel="author me" class="p-author h-card" href="/about"> <span itemprop="author"
          itemscope itemtype="http://schema.org/Person">
          <img class="u-photo" src="/images/joe2016.jpg" alt="" style="height: 16px; border-radius: 8px; margin-right: 4px;" />
          <span
            itemprop="name">Joe Gregorio</span></span></a>
      </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
      <p>
        The title of this article is actually misleading
        as the code isn't ported, but altered to run on both
        App Engine and under CGI. App Engine exposes a CGI 
        environment that your requests run under, so the real
        challenge comes from the differences in the runtime
        environment.
        </p>
<h3>Imaging</h3>
<p>
        The first big difference is that <a href="http://www.pythonware.com/products/pil/">PIL</a> (the Python Imaging
        Library) isn't available on App Engine, and it's not possible
        to add C extensions to your App Engine project, so we will have to find
        a pure Python substitute. Such a substitute exists in
        <a href="http://the.taoofmac.com/space/Projects/PNGCanvas">pngcanvas</a>, a pure Python module for creating PNG images.
        </p>
<p>
        My use of pngcanvas is actually the completion of a virtuous circle: 
        I originally created the <a href="http://bitworking.org/projects/sparklines/">Python sparklines service</a> and
        <a href="http://redhanded.hobix.com/inspect/sparklinesForMinimalists.html">why wanted to create one in Ruby</a> 
        using pure Ruby and BMPs, then that was the jumping off point for some commenters to
        do the same for PNGs, which led 
        <a href="http://mir.aculo.us/2005/09/17/pure-ruby-sparklines">mir.aculo.us</a> to create 
        a library for creating sparkline PNGs in pure Ruby, which 
        <a href="http://the.taoofmac.com/space/Projects/PNGCanvas">Rui Carmo then ported to Python</a>, 
        which I will now use in porting the original sparklines code to App Engine.
        Small world.
        </p>
<p>
        Now you probably won't want to use pngcanvas for 
        extensive graphics manipulation, but since sparklines
        are small it will be just fine.
        As a side note, I really like the simplicity of the
        pngcanvas interface, the port actually resulted in removing
        lines of code compared to PIL, which is always a good sign.
        </p>
<p>
        The one problem that arises in moving from PIL to pngcanvas
        is the lack of color names. PIL allows you to specify
        colors by name, something pngcanvas doesn't support.
        Luckily X11 includes a convenient list of color names
        and their equivalent in RGB triples (<code>/etc/X11/rgb.txt</code>)
        which just needs to be converted into a form usable for
        Python. I could write code to import <code>rgb.txt</code> via Python, but
        since I have to upload the file to App Engine anyway, I'll 
        exercise the macro capabilities of my text editor and
        covert it into a Python file:
        </p>
<pre class="prettyprint">_colors = {
"snow": (255, 250, 250, 255),
"ghost white": (248, 248, 255, 255),
"ghostwhite": (248, 248, 255, 255),
# ...
"light green": (144, 238, 144, 255),
"lightgreen": (144, 238, 144, 255)
}
def colors(name):
    name = name.strip().lower()
    if name in _colors:
        return _colors[name]
    else:
        return (0, 0, 0, 255)</pre>
<p>
        Now I can use <code>rgb.py</code> to covert color names into RGB triples, 
        or in this case RGBA tuples like <code>pngcanvas</code> expects. 
        </p>
<h3>App.yaml</h3>
<p>
        If we wanted to do the absolute minimum then
        that would be all the changes we would need to make.
        The only extra step needed for App Engine is to describe
        the files we are using and their location so it knows
        what to upload and how to direct requests, which is done
        through the <code>app.yaml</code> file.
        </p>
<pre class="prettyprint">application: sparklines-bitworking
version: 1
runtime: python
api_version: 1
handlers:
- url: /
  static_files: index.html
  upload: index.html
- url: /spark.js
  static_files: spark.js 
  upload: spark.js 
- url: /spark.cgi?.*
  script: spark.py
</pre>
<p>
        And were done. But there are some other changes we can make
        to take full advantage of the App Engine platform.
        </p>
<h3>The <code>main()</code> optimization</h3>
<p>
        If your handler script exports a <code>main()</code> function
        that takes no arguments then App Engine will keep the script
        cached and call <code>main()</code> for subsequent requests. 
        Skipping the evaluation of the script on each
        request improves performance, so we'll break out the code into two modules,
        <code>main.py</code> which will be our script handler
        and <code>script.py</code> which will contain
        all of the sparkline drawing logic.
        That change is now reflected in our <code>app.yaml</code>
        file:
        </p>
<pre class="prettyprint">application: sparklines-bitworking
version: 1
runtime: python
api_version: 1
handlers:
- url: /
  static_files: index.html
  upload: index.html
- url: /spark.js
  static_files: spark.js 
  upload: spark.js 
- url: /spark.cgi?.*
  script: main.py
        </pre>
<p>And the <code>main.py</code> is very simple:</p>
<pre class="prettyprint">from spark import plot
def main():
    plot()
if __name__ == '__main__':
    main()  </pre>
<h3>Memcache</h3>
<p>
        Now the original sparklines code already made good use
        HTTP caching by setting <code>ETag:</code> and <code>Cache-control:</code> headers, but
        we can do more under App Engine by using the memcache service.
        After drawing each sparkline we can store the PNG in 
        memcache using a hash of the incoming request query 
        parameters and the application version as the key 
        and subsequently look for images in memcache when 
        requests come in using that same hash. If there is a hit we can avoid 
        doing any drawing at all.
        We still want to be able to use the code on a
        system that doesn't have memcache support so
        we will make its use conditional.
        </p>
<pre class="prettyprint">try:
    from google.appengine.api import memcache
except:
    memcache = None
</pre>
<p>Check for memcached images:</p>
<pre class="prettyprint">def plot():
    plot_types = {
        'discrete': plot_sparkline_discrete, 
        'impulse': lambda data, args: plot_sparkline_discrete(data, args, True), 
        'smooth': plot_sparkline_smooth,
        'error': plot_error
    }
    if not os.environ['REQUEST_METHOD'] in ['GET', 'HEAD']:
        error("Status: 405 Method Not Allowed")
    if_none_match = os.environ.get('HTTP_IF_NONE_MATCH', '')
    hashkey = entity_hash()
    if if_none_match and hashkey == if_none_match:
        not_modified()
    <b>if memcache:
        image_data = memcache.get(hashkey)
        if image_data is not None:
            ok()
            sys.stdout.write(image_data)
            sys.exit()</b>
    form = cgi.FieldStorage()
    # ...
    </pre>
<p>Populate memcache with images after drawing them:</p>
<pre class="prettyprint">
    # ...
    image_data = plot_types[type](data, args)
    <b>if memcache:
        memcache.add(hashkey, image_data)</b>
    # ... 
    </pre>
<p>
    By making the use of memcache conditional on its presence
    this code can now be used both on App Engine and also on my 
    server which doesn't have memcache. 
    </p>
<p>
    This service can be found hosted at 
    both <a href="http://bitworking.org/projects/sparklines/">http://bitworking.org/projects/sparklines/</a> 
    and on Google App Engine at <a href="http://sparklines-bitworking.appspot.com/">http://sparklines-bitworking.appspot.com/</a>.
    Both are running the identical code, which can be found at  
    <a href="http://bitbucket.org/jcgregorio/sparklines/overview/">http://bitbucket.org/jcgregorio/sparklines/overview</a>.
    </p>
  
  

    <a href="https://brid.gy/publish/twitter"></a>
  </div>

  <script type="text/javascript" charset="utf-8">
    fetch('https://webmention.bitworking.org/Mentions', {
      cache: 'no-cache',
    }).then(function(resp) {
      if (!resp.ok) {
        return
      }
      resp.text().then(function(text) {
        document.getElementById('mentions').innerHTML = text;
      });
    });
  </script>
  <div id=mentions>
  </div>

  
    <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://bitworking.org/news/2009/01/porting-sparklines-to-app-engine';
      this.page.identifier = 'https://bitworking.org/news/2009/01/porting-sparklines-to-app-engine';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://bitworking-1.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  
</article>

      </div>
    </main><footer class="site-footer">

  <div class="wrapper">

    
    <div class="PageNavigation">
      
      <a class="prev" href="/news/2009/01/Gnome-JavaScript-and-Gio">&laquo;
        Gnome, JavaScript, Gio, FUSE, and Acme</a>
      
      
      <a class="next"
        href="/news/2009/01/time-machine">Time Machine &raquo;</a>
      
    </div>
    

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              BitWorking
            
            </li>
            
            <li><a rel=me class="u-email" href="mailto:joe@bitworking.org">joe@bitworking.org</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jcgregorio" rel=me><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jcgregorio</span></a>

          </li>
          

          <li>
            <a rel="me" href="https://mastodon.cc/@jcgregorio">
              <span class=icon>
                <svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 0 216 232" width="16px" xml:space="preserve">
                  <path d="M211.80734 139.0875c-3.18125 16.36625-28.4925
                  34.2775-57.5625 37.74875-15.15875 1.80875-30.08375
                  3.47125-45.99875
                  2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0
                  2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47
                  27.225 46.39125 27.9425 21.11625.7225 39.91875-5.20625
                  39.91875-5.20625l.8675 19.09s-14.77 7.93125-41.08125
                  9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23234
                  213.82 1.40609 165.31125.20859
                  116.09125c-.365-14.61375-.14-28.39375-.14-39.91875 0-50.33
                  32.97625-65.0825 32.97625-65.0825C49.67234 3.45375
                  78.20359.2425 107.86484 0h.72875c29.66125.2425 58.21125
                  3.45375 74.8375 11.09 0 0 32.975 14.7525 32.975 65.0825
                  0 0 .41375 37.13375-4.59875 62.915" fill="gray"/>
                  <path d="M177.50984 80.077v60.94125h-24.14375v-59.15c0-12.46875-5.24625-18.7975-15.74-18.7975-11.6025 0-17.4175 7.5075-17.4175 22.3525v32.37625H96.20734V85.42325c0-14.845-5.81625-22.3525-17.41875-22.3525-10.49375 0-15.74 6.32875-15.74 18.7975v59.15H38.90484V80.077c0-12.455 3.17125-22.3525 9.54125-29.675 6.56875-7.3225 15.17125-11.07625 25.85-11.07625 12.355 0 21.71125 4.74875 27.8975 14.2475l6.01375 10.08125 6.015-10.08125c6.185-9.49875 15.54125-14.2475 27.8975-14.2475 10.6775 0 19.28 3.75375 25.85 11.07625 6.36875 7.3225 9.54 17.22 9.54 29.675" fill="#fff"/>
                </svg>
              </span>
              <span class="username">jcgregorio</span></a>
            </a>
          </li>

          
          <li>
            <a href="https://twitter.com/bitworking" rel=me><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">bitworking</span></a>

          </li>
          

        </ul>
      </div>

      <div class="h-card footer-col footer-col-3">
        <p class="p-note">Joe Gregorio - REST, Web, Python, Go, APIs, Dad, Husband, Maker, or any linear combination of such. Googler.
</p>
        <a class="p-name u-url" href="https://bitworking.org" style="display: none"><img
          class="u-photo" src="/images/joe2016.jpg" alt="" />Joe Gregorio</a>
        <a rel=me class="u-email" href="mailto:joe@bitworking.org">joe@bitworking.org</a>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
